<!DOCTYPE html>
<html>
<head>
<title>credential-get.html</title>
<link rel="stylesheet" type="text/css" href="credential.css" />
<style type="text/css">
</style>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript" src="base64url.js"></script>
<script type="text/javascript" src="cbor.js"></script>
<script type="text/javascript" src="webauthn.js"></script>
<script type="text/javascript" src="settings.js"></script>
<script type="text/javascript">
var DOMContentLoaded = new Promise(resolve => window.addEventListener("DOMContentLoaded", () => resolve()));

var settings = readSettings();
var rpId = "";
var allowCredentials = "";
var userVerification = "";

function GetPublicKeyCredentialRequestOptions() {
	var challenge_promise = getRandomChallenge();
	return challenge_promise.then(challenge => {
		var publicKeyCredentialRequestOptions = {
			"publicKey": {
				"challenge":challenge,
				"timeout":30000,
			}
		};
		if(rpId != "") {
			publicKeyCredentialRequestOptions.publicKey.rpId = rpId;
		}
		if(allowCredentials != "") {
			publicKeyCredentialRequestOptions.publicKey.allowCredentials = [
				{
					"id":Uint8Array.from(atobUrlSafe(allowCredentials), t => t.charCodeAt(0)),
					"type":"public-key",
				}
			];
		}
		if(userVerification != "") publicKeyCredentialRequestOptions.publicKey.userVerification = userVerification;
		return publicKeyCredentialRequestOptions;
	});
}

Promise.all([DOMContentLoaded,PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()])
	.then(all => $("#isUserVerifyingPlatformAuthenticatorAvailable").toggleClass("error", !all[1]).val(all[1]))
	.catch(e => $("#isUserVerifyingPlatformAuthenticatorAvailable").addClass("error").val("Error: " + e));

var publicKeyCredentialRequestOptions_promise = null;

function InitializeDisplay() {
	createCredentialsList($("#publicKey\\.allowCredentials"), settings)
		.bind("change", e => allowCredentials = $(e.target).val()).bind("change", ShowPublicKeyCredentialRequestOptions);
	addOptions($("#publicKey\\.rpId"), ["",location.host]).bind("change", e => rpId = $(e.target).val()).bind("change", ShowPublicKeyCredentialRequestOptions);
	addOptions($("#publicKey\\.userVerification"), ["","required","preferred","discouraged"]).bind("change", e => userVerification = $(e.target).val()).bind("change", ShowPublicKeyCredentialRequestOptions);
	$("#credentials\\.get").bind("click", RequestPublicKeyCredential);
}

function ShowPublicKeyCredentialRequestOptions() {
	publicKeyCredentialRequestOptions_promise = GetPublicKeyCredentialRequestOptions();
	publicKeyCredentialRequestOptions_promise
		.then(publicKeyCredentialRequestOptions => $("#PublicKeyCredentialRequestOptions").val(JSON.stringify(publicKeyCredentialRequestOptions, replacer, 2)));
}
	
var publicKeyCredential_promise = Promise.reject();
var publicKeyCredential = null;
var clientDataJSON_promise = Promise.reject();
var clientDataJSON = null;
var authenticatorData_promise = Promise.reject();
var authenticatorData = null;
var jwk_promise = Promise.reject();
var signature_promise = Promise.reject();

function RequestPublicKeyCredential() {
	$("#PublicKeyCredential").val("");
	$("#clientDataJSON").val("");
	$("#authenticatorData").val("");
	$("#signature").val("");

	publicKeyCredential_promise = publicKeyCredentialRequestOptions_promise
		.then(publicKeyCredentialRequestOptions => navigator.credentials.get(publicKeyCredentialRequestOptions));
		
	DecodePublicKeyCredential();
}

function DecodePublicKeyCredential() {
	publicKeyCredential_promise
		.then(credential => $("#PublicKeyCredential").removeClass("error").val(JSON.stringify(credential, replacer, 2)))
		.catch(e => $("#PublicKeyCredential").addClass("error").val(e))
	publicKeyCredential_promise.then(credential => publicKeyCredential = credential);

	clientDataJSON_promise = publicKeyCredential_promise
		.then(credential => JSON.parse(Array.from(new Uint8Array(credential.response.clientDataJSON), t => String.fromCharCode(t)).join("")));
	clientDataJSON_promise.then(value => $("#clientDataJSON").val(JSON.stringify(value, replacer, 2)));
	clientDataJSON_promise.then(value => clientDataJSON = value);

	authenticatorData_promise = publicKeyCredential_promise
		.then(credential => decodeAuthenticatorData(credential.response.authenticatorData));
	authenticatorData_promise.then(value => $("#authenticatorData").val(JSON.stringify(value, replacer, 2)));
	authenticatorData_promise.then(value => authenticatorData = value);
	
	jwk_promise = publicKeyCredential_promise
		.then(value => getCredential(settings, value.id))
		.then(cred => cred.credentialPublicKey);
	jwk_promise.then(value => $("#credentialPublicKey").val(JSON.stringify(value, replacer, 2)));
	
	signature_promise = Promise.all([publicKeyCredential_promise,jwk_promise])
		.then(all => verifyAssertionSignature(all[0], all[1]))
		
	signature_promise
		.then(result => console.log("verifyAssertionSignature: return "+result))
		.catch(e => console.error("verifyAssertionSignature: error "+e));
		
	signature_promise
		.then(value => $("#signature").toggleClass("error", !value).val(value))
		.catch(e => $("#signature").toggleClass("error", true).val("Error: " + e));
}
	
DOMContentLoaded.then(() => InitializeDisplay());
DOMContentLoaded.then(() => ShowPublicKeyCredentialRequestOptions());	
</script>
</head>
<body>

<table>
<tr><td colspan="2">[<a href="credential-create.html">create</a>] [<a href="credential-get.html">get</a>] [<a href="credential-edit.html">edit</a>]</td></tr>
<tr><td><a target="_blank" href="https://w3c.github.io/webauthn/#isUserVerifyingPlatformAuthenticatorAvailable">PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()</a></td><td><input type="text" readonly="readonly" id="isUserVerifyingPlatformAuthenticatorAvailable" /></td></tr>
<tr><td><a target="_blank" href="https://w3c.github.io/webauthn/#dictdef-publickeycredentialrequestoptions">PublicKeyCredentialRequestOptions</a></td></tr>
<tr><td><a target="_blank" href="https://w3c.github.io/webauthn/#dom-publickeycredentialrequestoptions-rpid">publicKey.rpId</a></td><td><select id="publicKey.rpId"></select></td></tr>
<tr><td><a target="_blank" href="https://w3c.github.io/webauthn/#dom-publickeycredentialrequestoptions-allowcredentials">publicKey.allowCredentials</a></td><td><select id="publicKey.allowCredentials"></select></td></tr>
<tr><td><a target="_blank" href="https://w3c.github.io/webauthn/#dom-publickeycredentialrequestoptions-userverification">publicKey.userVerification</a></td><td><select id="publicKey.userVerification"></select></td></tr>
<tr><td colspan="2"><textarea id="PublicKeyCredentialRequestOptions" rows="14" cols="80" readonly="readonly"></textarea></td></tr>
<tr><td><input id="credentials.get" type="button" value="credentials.get()" /></td></tr>
<tr><td><a target="_blank" href="https://w3c.github.io/webauthn/#publickeycredential">PublicKeyCredential</a></td></tr>
<tr><td colspan="2"><textarea id="PublicKeyCredential" rows="12" cols="80" readonly="readonly"></textarea></td></tr>
<tr><td><a target="_blank" href="https://w3c.github.io/webauthn/#dom-authenticatorresponse-clientdatajson">clientDataJSON</a></td></tr>
<tr><td colspan="2"><textarea id="clientDataJSON" rows="8" cols="80" readonly="readonly"></textarea></td></tr>
<tr><td><a target="_blank" href="https://w3c.github.io/webauthn/#sec-authenticator-data">authenticatorData</a></td></tr>
<tr><td colspan="2"><textarea id="authenticatorData" rows="11" cols="80" readonly="readonly"></textarea></td></tr>
<tr><td><a target="_blank" href="https://w3c.github.io/webauthn/#credentialpublickey">credentialPublicKey</a> (from sessionStorage)</td></tr>
<tr><td colspan="2"><textarea id="credentialPublicKey" rows="7" cols="80" readonly="readonly"></textarea></td></tr>
<tr><td><a target="_blank" href="https://w3c.github.io/webauthn/#fig-signature">signature</a></td><td><input id="signature" type="text" readonly="readonly" /></td></tr>
</table>

</body>
</html>
